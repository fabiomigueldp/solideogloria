<!DOCTYPE html>
<html lang="la">
<head>
  <meta charset="UTF-8">
  <title>COSMOGENESIS ABSOLUTA AETERNA - DIVINA SAPIENTIA OMNIA CREAVIT</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Trajan+Pro:wght@400;700&family=Noto+Serif+Hebrew:wght@300;400;700&family=Noto+Serif+Greek:ital,wght@0,300;0,400;0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300..0,700;1,300..0,700&family=Marcellus+SC&family=UnifrakturMaguntia&family=EB+Garamond:ital,wght@0,400..0,800;1,400..0,800&display=swap" rel="stylesheet">
  <style>
    /* RADICES STYLORUM CANONICORUM - PALETTA DIVINA PERFECTISSIMA */
    :root {
      --kenoma-profundum: #000000; --scintilla-prima: #FFFFFF;
      --lux-increata-effulgentia: rgba(255, 255, 255, 0.98);
      --lumen-divinum-aurum: #FFDF00; --lumen-sapientiae-sapphirus: #07196F;
      --lumen-amoris-ignis: #CC0000; --lumen-seraphicum-flamma: #FF7700;
      --lumen-cherubicum-caeruleum: #4169E1; /* RoyalBlue */ --lumen-thronorum-crystallus: #AFEEEE; /* PaleTurquoise */
      --vestigia-dei-amethystus: #8A2BE2; /* BlueViolet */ --anima-cosmica-smaragdus: #008080; /* Teal */
      --pleroma-alba-margarita: #FAF0E6; --reditus-viola-obscura: #1C001E;
      --lingua-sacra-aux-color: rgba(230, 230, 210, 0.8);
      --cosmic-filament-color: rgba(0, 128, 128, 0.4);
      --nebular-swirl-core: rgba(220, 200, 255, 0.30);
      --ignis-divinus-fulgor: rgba(255,223,0,0.9);
    }
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--kenoma-profundum); font-family: 'Cormorant Garamond', 'Trajan Pro', serif; opacity: 0; transition: opacity 7s ease-out; will-change: opacity; }
    #theosis-theatrum { position: fixed; top: 0; left: 0; width: 100%; height: 100%; perspective: 4000px; perspective-origin: 50% 50%; z-index: 1; transform-style: preserve-3d; animation: spiritusMundiRespiratio 75s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite alternate; will-change: transform, filter;}
    @keyframes spiritusMundiRespiratio { 0% { transform: scale(1.000) translateZ(0px); filter: brightness(0.97) saturate(0.98); } 100% { transform: scale(1.004) translateZ(10px); filter: brightness(1.03) saturate(1.02); } }
    #background-aether-canvas { position: fixed; top:0; left:0; width:100%; height:100%; z-index: -5; pointer-events:none;}
    #visio-plena-thronus { position: fixed; bottom: 35px; right: 35px; padding: 18px 30px; border-radius: 7px; background: radial-gradient(ellipse at center, rgba(255,223,0,0.05) 0%, rgba(0,0,0,0.5) 100%), linear-gradient(160deg, rgba(255,210,0,0.15) 0%, rgba(170,50,0,0.25) 100%); color: var(--lumen-divinum-aurum); border: 2px solid; border-image-source: linear-gradient(160deg, var(--lumen-divinum-aurum), var(--lumen-amoris-ignis)); border-image-slice: 1; font-family: 'Marcellus SC', 'Mate SC', serif; font-size: 17px; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; opacity: 0.85; text-shadow: 0 0 5px var(--lumen-divinum-aurum), 0 0 10px var(--lumen-amoris-ignis); box-shadow: 0 0 10px rgba(255,223,0,0.1), 0 0 20px rgba(255,100,0,0.1), inset 0 0 8px rgba(255,255,255,0.03), inset 0 0 15px rgba(255,223,0,0.05); transition: all 0.6s cubic-bezier(0.075, 0.82, 0.165, 1); z-index: 100001; transform: translateZ(50px); will-change: transform, opacity, box-shadow; }
    #visio-plena-thronus:hover, #visio-plena-thronus:focus { opacity: 1; transform: scale(1.05) translateY(-3px) translateZ(60px) rotateX(-2deg); box-shadow: 0 8px 30px rgba(255,223,0,0.3), 0 5px 20px rgba(255,100,0,0.3), inset 0 0 10px rgba(255,255,255,0.05), inset 0 0 20px rgba(255,223,0,0.08); border-image-source: linear-gradient(160deg, var(--lumen-amoris-ignis), var(--lumen-divinum-aurum)); text-shadow: 0 0 8px var(--lumen-divinum-aurum), 0 0 15px var(--lumen-amoris-ignis), 0 0 25px var(--scintilla-prima); }
    body:fullscreen #visio-plena-thronus, body:-webkit-full-screen #visio-plena-thronus { display: none; }
    #principium-incognitum { position: absolute; top: 50%; left: 50%; width: 0.5px; height: 0.5px; border-radius: 50%; background-color: var(--scintilla-prima); opacity: 0; transform: translate3d(-50%, -50%, -1500px) scale(0.0001); z-index: 5000; filter: brightness(1); will-change: transform, opacity, box-shadow, filter; }
    .lux-prima-unda { position: absolute; border-radius: 50%; border: 0.2px solid var(--lux-increata-effulgentia); opacity: 0; pointer-events: none; z-index: 1000; filter: blur(0.2px) brightness(2.5); mix-blend-mode: screen; will-change: transform, opacity, filter, border-width; }
    .ignis-divinus-scintilla-ultra { position: absolute; border-radius: 50%; opacity: 0; pointer-events: none; z-index: 1800; mix-blend-mode: add; will-change: transform, opacity, background-color, box-shadow; transform-style: preserve-3d; }
    .ignis-trail-segment { position: absolute; width: 100%; height: 100%; border-radius: 50%; opacity: 1; transform-origin: center center; will-change: transform, opacity, background; }
    .angelorum-chorus-particula { position: absolute; border-radius: 50%; opacity: 0; pointer-events: none; z-index: 500; transform-style: preserve-3d; will-change: transform, opacity, background-color, box-shadow; }
    .particula-aura-divina { position: absolute; top:50%; left:50%; width: 1px; height:1px; border-radius: 50%; opacity: 0; transform-style:preserve-3d; will-change: transform, opacity, background;}
    .particula-cometa-cauda { position: absolute; top: 50%; left: 50%; height: 1px; opacity: 1; transform-origin: 0% 50%; transform-style: preserve-3d; will-change: transform, opacity, width; }
    .cauda-stratum { position:absolute; width:100%; height:100%; transform-origin: 0% 50%; border-radius: 0 50% 50% 0; will-change: transform, opacity, background; }
    .sophia-nebula-majestas { position: absolute; opacity: 0; pointer-events: none; z-index: 100; transform-style: preserve-3d; mix-blend-mode: lighten; animation: nebulaReginaSaltatio 300s cubic-bezier(0.42, 0, 0.58, 1) infinite alternate, nebulaFormaTransfiguratio 220s ease-in-out infinite alternate, nebulaInternaFluctuatio 40s ease-in-out infinite alternate; will-change: transform, opacity, border-radius, filter, background-position; }
    @keyframes nebulaInternaFluctuatio { 0%, 100% { background-position: 0% 0%, 100% 100%, 50% 50%, 0% 100%, 100% 50%; } 50% { background-position: 50% 100%, 50% 0%, 0% 50%, 100% 0%, 0% 0%; } }
    @keyframes nebulaReginaSaltatio { 0% { transform: translate3d(-50%, -50%, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(0.95); filter: saturate(0.9) brightness(0.95); } 25% { transform: translate3d(-50%, -50%, 100px) rotateX(15deg) rotateY(-10deg) rotateZ(20deg) scale(1); filter: saturate(1.1) brightness(1.05); } 50% { transform: translate3d(-50%, -50%, -50px) rotateX(-5deg) rotateY(20deg) rotateZ(-15deg) scale(1.05); filter: saturate(1) brightness(1); } 75% { transform: translate3d(-50%, -50%, 50px) rotateX(10deg) rotateY(-15deg) rotateZ(5deg) scale(0.98); filter: saturate(1.2) brightness(1.1); } 100% { transform: translate3d(-50%, -50%, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(0.95); filter: saturate(0.9) brightness(0.95); } }
    @keyframes nebulaFormaTransfiguratio { 0% { border-radius: 35% 65% 70% 30% / 30% 60% 40% 70%; } 33% { border-radius: 70% 30% 50% 50% / 60% 30% 70% 40%; } 66% { border-radius: 50% 50% 30% 70% / 40% 70% 30% 60%; } 100% { border-radius: 35% 65% 70% 30% / 30% 60% 40% 70%; } }
    .gratia-flumen-magnum { position: absolute; height: 2px; opacity: 0; pointer-events: none; z-index: 200; transform-style: preserve-3d; filter: blur(0.8px) drop-shadow(0 0 6px var(--lumen-divinum-aurum)) drop-shadow(0 0 12px var(--pleroma-alba-margarita)); will-change: transform, opacity, width, offset-path, offset-distance; }
    .flumen-particula-undae { position:absolute; width: 2px; height: 2px; border-radius:50%; will-change: transform, opacity, background-color, offset-path, offset-distance; }
    #logos-divinus-thronus { position: fixed; width: 100%; height: 100%; top: 0; left: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; pointer-events: none;}
    .verbum-container { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity:0; will-change: transform, opacity, filter; }
    .verbum-principale { font-family: 'Trajan Pro', 'Noto Serif Hebrew', 'Noto Serif Greek', 'Cinzel Decorative', serif; font-weight: 700; color: var(--scintilla-prima); text-shadow: 0 0 3px #fff, 0 0 7px #fff, 0 0 12px #fff, 0 0 20px var(--pleroma-alba-margarita), 0 0 30px var(--pleroma-alba-margarita), 0 0 45px var(--lumen-divinum-aurum), 0 0 60px var(--lumen-divinum-aurum), 0 0 80px var(--lumen-sapientiae-sapphirus), 0 0 100px var(--lumen-sapientiae-sapphirus), 0 0 125px var(--lumen-amoris-ignis), 0 0 150px var(--lumen-amoris-ignis), 0 0 180px var(--vestigia-dei-amethystus), 0 0 220px var(--pleroma-alba-margarita); position: relative; z-index: 2; filter: brightness(1.0); will-change: filter; }
    .verbum-glosa-latina { font-family: 'Cormorant Garamond', serif; font-size: 0.2em; font-style: italic; color: var(--lingua-sacra-aux-color); text-shadow: 0 0 3px var(--lingua-sacra-aux-color), 0 0 5px rgba(0,0,0,0.5); margin-top: 0.5em; opacity: 0.8; position: relative; z-index: 1; letter-spacing: 0.05em; will-change: opacity; }
    @keyframes verbumEmergentiaDivina { 0% { opacity: 0; transform: translate3d(0, 0, -1800px) scale(0.08) rotateX(85deg) rotateY(var(--rand-rotY-start, 0deg)); filter: blur(45px) brightness(0.4) saturate(0.3); } 5% { filter: blur(25px) brightness(2.5) saturate(0.9); } 25% { opacity: 1; transform: translate3d(0, 0, 0px) scale(1) rotateX(0deg) rotateY(0deg); filter: blur(0px) brightness(1.3) saturate(1.2); } 30%, 70% { opacity: 1; transform: translate3d(0, 0, var(--reverb-z, 10px)) scale(var(--reverb-scale, 1.005)) rotateX(var(--reverb-rotX, -0.5deg)) rotateY(var(--reverb-rotY, 0.2deg)); filter: blur(var(--reverb-blur, 0.2px)) brightness(var(--reverb-brightness, 1.25)) saturate(1.1); } 100% { opacity: 0; transform: translate3d(0, 0, 2500px) scale(4.0) rotateX(var(--rand-rotX-end, -70deg)) rotateY(var(--rand-rotY-end, 5deg)); filter: blur(55px) brightness(0.3) saturate(0.2); } }
    .ordo-creationis-sigillum { position: absolute; top:50%; left:50%; transform-style: preserve-3d; opacity:0; pointer-events: none; z-index: 5000; filter: drop-shadow(0 0 15px rgba(255,223,0,0.25)); will-change: transform, opacity; }
    .sigillum-stratum { position: absolute; transform-origin: center center; border-width: 0.2px; border-style: solid; background-color: transparent; will-change: transform, opacity, border-color, box-shadow; transform-style: preserve-3d;}
    .spiralis-nebulae-primordialis { position: absolute; border-radius: 50%; transform-origin: center center; will-change: transform, opacity, border-image-source; z-index:90; pointer-events:none; border-style: solid; border-width: 1px; }
    .filum-cosmicum-lucis { position: absolute; background-color: var(--cosmic-filament-color); box-shadow: 0 0 3px var(--cosmic-filament-color), 0 0 5px var(--pleroma-alba-margarita); will-change: transform, opacity, width; height: 1.5px; z-index: 85; pointer-events:none; transform-origin: 0 50%; }
    .vortex-energia-creativa { position: absolute; width: 1px; height: 1px; border-radius: 50%; filter: blur(1.5px); transform-origin: center center; will-change: transform, opacity, background; z-index: 5100; pointer-events:none; mix-blend-mode: screen;}
  </style>
</head>
<body>
  <canvas id="background-aether-canvas"></canvas>
  <button id="visio-plena-thronus" aria-label="Ingressar na Visão Plena">VISIO PLENA</button>
  <div id="theosis-theatrum">
    <!-- Principium will be created dynamically if needed -->
  </div>
  <div id="logos-divinus-thronus"></div>

  <script>
    // SCRIPTOR DIVINUS - EDITIO AETERNA ET ABSOLUTA
    "use strict";

    /* CONSTANTES PHILOSOPHICO-MATHEMATICAE ET DIVINAE PERFECTISSIMAE */
    const K_DIVINI_MODI = { RAND: (a,b)=>Math.random()*(b-a)+a, RAND_INT: (a,b)=>Math.floor(Math.random()*(b-a+1))+a, CHOICE:a=>a[Math.floor(Math.random()*a.length)], DEG_AD_RAD:Math.PI/180, TWO_PI: Math.PI*2, MAX_NEBULAE_ULTRA: 8 };

    /* CONSTANTES TEMPORALES PERFECTISSIMAE */
    const K_TEMPORA_PERFECTISSIMA = {
        princEmerg: 3000,
        princRad: 8000,
        luxUndaSer: 10000,
        manifestContinInterIgnis: 800,
        chorSeraphInit: 12000,
        sophNebPrim: 15000,
        gratFlumPrim: 18000,
        logosPrimProclam: 20000,
        logosFinalDur: 25,
        reditusAnagogIncep: 180000
    };

    /* CACHE DOMUS SANCTAE PERFECTISSIMAE */
    const D_ELEMENTA = { 
        get theatrum(){return document.getElementById('theosis-theatrum')}, 
        get logosThronus(){return document.getElementById('logos-divinus-thronus')}, 
        get principium(){return document.getElementById('principium-incognitum')},
        btnVisioPlena:document.getElementById('visio-plena-thronus'), 
        bgCanvas:document.getElementById('background-aether-canvas'), 
        get bgCtx(){return this.bgCanvas.getContext('2d');}
    };

    /* STATUS MANIFESTATIONIS DIVINAE PERFECTISSIMAE */
    let M_DIVINITAS = { activa:!0, idxLogos:0, elementaActiva:new Set(), idFrameAnim:null, tmpUltimum:0, particulaeAetheris:[], MAX_PART_AETHERIS_ULTRA:450, intervalorumId: new Set() };

    /* SEQUENTIA LOGOS DIVINI CUM GLOSSIS ET EFFECTIBUS SPECIFICIS PERFECTISSIMIS */
    const K_LOGOS_ULTRA_PERFECTISSIMA = [
        { t:"תהו ובהו", f:"'Noto Serif Hebrew', serif", sr:0.9, c:"var(--pleroma-alba-margarita)", gl:"Inane et Vacuum", ai:1.5, es:"vacuumPrimordiale", dE:4000 },
        { t:"Fiat Lux", f:"'Trajan Pro', serif", sr:1.05, c:"var(--lux-increata-effulgentia)", gl:"Et Lux Facta Est", ai:2.2, es:"fiatLuxCosmica", dE:4000 },
        { t: "In Principio Erat Verbum", f: "'Trajan Pro', serif", sr: 1.15, c: "var(--lumen-divinum-aurum)", gl: "Et Deus erat Verbum", ai: 2.2, es: "crystallizatioHarmonica", dE: 4500 },
        { t:"בראשית", f:"'Noto Serif Hebrew', serif", sr:0.9, c:"var(--lumen-divinum-aurum)", gl:"In Principio Creavit Deus", ai:1.3, es:"genesisSpiraliumNebulosarum", dE:4500 },
        { t:"λόγος σάρξ ἐγένετο", f:"'Noto Serif Greek', serif", sr:0.85, c:"var(--lumen-amoris-ignis)", gl:"Verbum Caro Factum Est", ai:1.9, es:"unioDivinoHumana", dE:4500 },
        { t:"Spiritus Mundi Fluit", f:"'Cormorant Garamond', serif", sr:0.95, c:"var(--anima-cosmica-smaragdus)", gl:"Anima Universi Vitalis", ai:1.4, es:"flumenVitaeSmaragdinum", dE:4200 },
        { t:"Ordo Ab Chao", f:"'Cinzel Decorative', serif", sr:1.0, c:"var(--lumen-sapientiae-sapphirus)", gl:"Harmonia Ex Dissonantia", ai:1.6, es:"crystallizatioHarmonica", dE:4200 },
        { t:"Amor Est Vis Unifica", f:"'UnifrakturMaguntia', serif", sr:1.1, c:"var(--lumen-amoris-ignis)", gl:"Deus Caritas Est", ai:2.0, es:"nexusAmorisCosmici", dE:4000 },
        { t:"Gloria Dei Vivens Homo", f:"'Marcellus SC', serif", sr:1.1, c:"var(--pleroma-alba-margarita)", gl:"Creatura Reflectens Lumen Creatoris", ai:1.8, es:"chorusLaudisUniversalis", dE:4800 },
        { t:"Α Kai Ω", f:"'Noto Serif Greek', serif", sr:1.15, c:"var(--scintilla-prima)", gl:"Principium et Finis", ai:2.3, es:"alphaOmegaSigillum", dE:5000 },
        { t: "THEOSIS ULTIMA", f: "'Trajan Pro', serif", sr: 1.25, c: "var(--scintilla-prima)", gl: "Deificatio Consummata et Reditus", ai: 3.0, es: "apotheosisLuminosa", dE: 6000 }
    ];
    
    // As funções de criação de elementos (creaLuxPrimaUndaPerfectissima, creaIgnisDivinusPerfectissima, etc.) são mantidas como na versão anterior.
    // Incluiremos as implementações para os efeitos que estavam faltando.
    
    /* ---- FUNÇÕES DE EFEITOS ESPECÍFICOS ADORMECIDOS, AGORA DESPERTOS ---- */

    function creaVortexEnergiaCreativa(d, opts={}) {
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const { intensity = 1, color = 'var(--reditus-viola-obscura)', z = 0 } = opts;
            const numParticles = K_DIVINI_MODI.RAND_INT(50, 80) * intensity;
            const vortexCenterX = innerWidth / 2;
            const vortexCenterY = innerHeight / 2;

            for (let i = 0; i < numParticles; i++) {
                const v = document.createElement('div');
                v.classList.add('vortex-energia-creativa');
                M_DIVINITAS.elementaActiva.add(v);
                
                const angle = K_DIVINI_MODI.RAND(0, K_DIVINI_MODI.TWO_PI);
                const startRadius = K_DIVINI_MODI.RAND(innerWidth * 0.6, innerWidth * 0.8);
                const startX = vortexCenterX + Math.cos(angle) * startRadius;
                const startY = vortexCenterY + Math.sin(angle) * startRadius;
                const size = K_DIVINI_MODI.RAND(1, 4) * intensity;
                v.style.width = `${size}px`;
                v.style.height = `${size}px`;
                v.style.left = `${startX}px`;
                v.style.top = `${startY}px`;
                v.style.background = `radial-gradient(circle, ${color}, transparent 70%)`;

                D_ELEMENTA.theatrum.appendChild(v);
                
                const duration = K_DIVINI_MODI.RAND(3000, 5000);
                const endRadius = K_DIVINI_MODI.RAND(10, 30);
                const endAngle = angle + K_DIVINI_MODI.RAND(K_DIVINI_MODI.TWO_PI * 2, K_DIVINI_MODI.TWO_PI * 4);
                const endX = vortexCenterX + Math.cos(endAngle) * endRadius;
                const endY = vortexCenterY + Math.sin(endAngle) * endRadius;

                v.animate([
                    { transform: `translate3d(-50%,-50%,${z}px) scale(1)`, opacity: 1 },
                    { transform: `translate3d(-50%,-50%,${z}px) translate(${endX - startX}px, ${endY - startY}px) scale(0.1)`, opacity: 0, offset: 1 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.5, 0, 1, 0.5)',
                    delay: i * 10
                }).onfinish = () => { if (v.parentNode) v.remove(); M_DIVINITAS.elementaActiva.delete(v); };
            }
        }, d);
    }

    function creaSpiralisNebulaePerfectissima(d, opts={}) {
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const { intensity = 1, z = K_DIVINI_MODI.RAND(-500, 500) } = opts;
            const numArms = K_DIVINI_MODI.RAND_INT(2, 5);
            const armRotation = K_DIVINI_MODI.TWO_PI / numArms;

            for (let i = 0; i < numArms; i++) {
                const s = document.createElement('div');
                s.classList.add('spiralis-nebulae-primordialis');
                M_DIVINITAS.elementaActiva.add(s);

                const size = K_DIVINI_MODI.RAND(800, 1500) * intensity;
                s.style.width = `${size}px`;
                s.style.height = `${size}px`;
                s.style.top = '50%';
                s.style.left = '50%';
                
                const startHue = K_DIVINI_MODI.RAND(180, 280);
                s.style.borderImageSource = `conic-gradient(from ${i * armRotation}rad at 50% 50%, transparent, hsla(${startHue}, 90%, 70%, 0.5), transparent)`;
                s.style.borderImageSlice = '1';
                
                D_ELEMENTA.theatrum.appendChild(s);
                
                const duration = K_DIVINI_MODI.RAND(8000, 12000);
                const initialRot = K_DIVINI_MODI.RAND(-30, 30);
                s.animate([
                    { transform: `translate(-50%, -50%) translateZ(${z}px) scale(0.01) rotateZ(${initialRot}deg)`, opacity: 0 },
                    { opacity: 1, offset: 0.1 },
                    { opacity: 0.7, offset: 0.9 },
                    { transform: `translate(-50%, -50%) translateZ(${z}px) scale(1) rotateZ(${initialRot + K_DIVINI_MODI.RAND(90, 180)}deg)`, opacity: 0, offset: 1 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.22, 1, 0.36, 1)'
                }).onfinish = () => { if (s.parentNode) s.remove(); M_DIVINITAS.elementaActiva.delete(s); };
            }
        }, d);
    }
    
    function creaFilumCosmicumLucis(d, opts={}) {
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const { intensity = 1, numFilaments = K_DIVINI_MODI.RAND_INT(5,10) } = opts;
            
            for (let i = 0; i < numFilaments; i++) {
                const f = document.createElement('div');
                f.classList.add('filum-cosmicum-lucis');
                M_DIVINITAS.elementaActiva.add(f);

                const startX = K_DIVINI_MODI.RAND(0, innerWidth);
                const startY = K_DIVINI_MODI.RAND(0, innerHeight);
                const z = K_DIVINI_MODI.RAND(-1000, 1000);
                const length = K_DIVINI_MODI.RAND(200, 500) * intensity;
                const angle = K_DIVINI_MODI.RAND(0, 360);

                f.style.left = `${startX}px`;
                f.style.top = `${startY}px`;
                f.style.width = `${length}px`;
                f.style.transform = `translateZ(${z}px) rotate(${angle}deg)`;
                
                D_ELEMENTA.theatrum.appendChild(f);
                
                const duration = K_DIVINI_MODI.RAND(5000, 8000);
                f.animate([
                    { transform: f.style.transform + ' scaleX(0)', opacity: 0 },
                    { opacity: 1, offset: 0.1 },
                    { opacity: 0, offset: 1 },
                    { transform: f.style.transform + ' scaleX(1)', opacity: 0, offset: 1 }
                ], {
                    duration: duration,
                    easing: 'ease-out'
                }).onfinish = () => { if (f.parentNode) f.remove(); M_DIVINITAS.elementaActiva.delete(f); };
            }
        }, d);
    }


    /* ---- IMPLEMENTAÇÃO COMPLETA DOS EFEITOS ESPECÍFICOS ---- */
    
    function exsecuteEffectusSpecificus(effectName, intensity) {
        // O Santuário das Invocações, agora em plena atividade.
        switch(effectName) {
            case "vacuumPrimordiale":
                creaVortexEnergiaCreativa(500, { intensity: intensity, color: 'var(--reditus-viola-obscura)', z: K_DIVINI_MODI.RAND(-200, 200) });
                break;

            case "fiatLuxCosmica":
                document.body.style.opacity = 1; // Trigger page fade-in
                setTimeout(manifestaPrincipiumPerfectissimum, 500); // Call manifestaPrincipiumPerfectissimum

                const flashDivino = document.createElement('div');
                flashDivino.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background-color:var(--scintilla-prima); z-index:100000; pointer-events:none; opacity:0;';
                document.body.appendChild(flashDivino);
                M_DIVINITAS.elementaActiva.add(flashDivino);
                flashDivino.animate([ { opacity: 0 }, { opacity: intensity / 3.5, offset: 0.05 }, { opacity: 0, offset: 1 } ], { duration: 3500 * intensity, easing: 'cubic-bezier(0.19, 1, 0.22, 1)' }).onfinish = () => { if (flashDivino.parentNode) flashDivino.remove(); M_DIVINITAS.elementaActiva.delete(flashDivino); };
                for(let i = 0; i < 70 * intensity; i++) { creaIgnisDivinusPerfectissima(i * 5, 2.5 * intensity); }

                // Re-initiate Background Effects (moved from initiaTheophaniamPerfectissimam)
                // Initial burst of Lux Unda
                for(let i=0; i < 40; i++) creaLuxPrimaUndaPerfectissima(i * 50 + K_DIVINI_MODI.RAND(-20,20)); // Staggered slightly

                // Activate continuous fire (after a brief delay)
                setTimeout(() => activateIgnisDivinusContinuus(K_TEMPORA_PERFECTISSIMA.manifestContinInterIgnis, 2.0), 500);

                // Initial batch of Angelic Choirs (staggered)
                setTimeout(() => {
                    ['seraphim','cherubim','thrones','dominatio','virtus','potestas','principatus','archangelus','angelus'].forEach((t,idx)=>{
                        creaChorusAngelorumPerfectissimus(idx*150, t,
                            {x:K_DIVINI_MODI.RAND(10,90),y:K_DIVINI_MODI.RAND(10,90),z:K_DIVINI_MODI.RAND(-1200,1200)},
                            {radMin:300,radMax:2000,velMin:0.2,velMax:2.2,compMin:5,compMax:12,numPart:K_DIVINI_MODI.RAND_INT(2,5),auraLayers:K_DIVINI_MODI.RAND_INT(2,4),trailLength:K_DIVINI_MODI.RAND(4,10)});
                    });
                }, 1000);

                // Initial Nebulae (staggered)
                setTimeout(() => {
                    for(let i=0; i<K_DIVINI_MODI.MAX_NEBULAE_ULTRA;i++) creaSophiaNebulaPerfectissima(i*800+K_DIVINI_MODI.RAND(-250,250));
                }, 2000);

                // Initial Grace Rivers (staggered)
                setTimeout(() => {
                    for(let i=0; i<15;i++) creaGratiaFlumenPerfectissimum(i*700+K_DIVINI_MODI.RAND(-200,200)); // Reduced count for initial burst
                }, 3000);

                // Setup K_CONTIN_ULTRA_PERF continuous effects (these have their own internal delays `tsk.d`)
                const K_CONTIN_ULTRA_PERF_FIATLUX=[
                    {f:creaLuxPrimaUndaPerfectissima,i:5000,d:K_DIVINI_MODI.RAND(0,2000)},
                    {f:()=>creaChorusAngelorumPerfectissimus(0,K_DIVINI_MODI.CHOICE(['seraphim','cherubim','thrones','dominatio','virtus','potestas','principatus','archangelus','angelus'])),i:3000,d:K_DIVINI_MODI.RAND(0,1000)},
                    {f:creaSophiaNebulaPerfectissima,i:7000,d:K_DIVINI_MODI.RAND(0,3000)},
                    {f:creaGratiaFlumenPerfectissimum,i:6000,d:K_DIVINI_MODI.RAND(0,2500)},
                    {f:()=>creaSymbolaCosmica(0,K_DIVINI_MODI.RAND(0.7,1.5)),i:9000,d:K_DIVINI_MODI.RAND(0,4000)}
                ];
                K_CONTIN_ULTRA_PERF_FIATLUX.forEach(tsk=>{
                    setTimeout(()=>{
                        if(M_DIVINITAS.activa)tsk.f(0); // Initial call
                        const id=setInterval(()=>{if(M_DIVINITAS.activa)tsk.f(0);else clearInterval(id);},tsk.i);
                        M_DIVINITAS.elementaActiva.add(id); // Or intervalorumId if that's preferred tracking
                    }, tsk.d + 500); // Add a small base delay to ensure FiatLux core effect is visible
                });
                break;

            case "genesisSpiraliumNebulosarum":
                creaSpiralisNebulaePerfectissima(1000, { intensity: intensity, z: K_DIVINI_MODI.RAND(-800, 800) });
                break;
                
            case "unioDivinoHumana":
                for(let i = 0; i < 5 * intensity; i++) { creaGratiaFlumenPerfectissimum(i * 300, { colorOverride: 'var(--lumen-amoris-ignis)' }); }
                break;

            case "flumenVitaeSmaragdinum":
                 creaFilumCosmicumLucis(800, { intensity: intensity, numFilaments: K_DIVINI_MODI.RAND_INT(10, 20) * intensity });
                 break;

            case "crystallizatioHarmonica":
                for(let i = 0; i < 3 * intensity; i++) { creaOrdoSigillumPerfectissimum(i * 500, { ai: intensity * 1.5 }); }
                break;
                
            case "nexusAmorisCosmici":
                for(let i = 0; i < 15 * intensity; i++) { creaIgnisDivinusPerfectissima(i * 100, intensity * 1.8, null, { connect: true }); }
                break;

            case "chorusLaudisUniversalis":
                // Intensifica a criação contínua de anjos por um tempo
                const chorusInterval = setInterval(() => {
                    creaChorusAngelorumPerfectissimus(0, K_DIVINI_MODI.CHOICE(['seraphim', 'cherubim']), { x: K_DIVINI_MODI.RAND(10, 90), y: K_DIVINI_MODI.RAND(10, 90), z: K_DIVINI_MODI.RAND(-1200, 1200) }, { numPart: 1, radMin: 800, radMax: 2500, trailLength: 15 });
                }, 500);
                setTimeout(() => clearInterval(chorusInterval), 8000 * intensity);
                break;
                
            case "alphaOmegaSigillum":
                creaOrdoSigillumPerfectissimum(500, { ai: intensity * 2.5, isAlphaOmega: true });
                break;

            case "apotheosisLuminosa":
                // Este efeito é a transição, tratada no fluxo principal do ciclo.
                break;
        }
    }
    
    // Todas as outras funções de criação (manifestaPrincipiumPerfectissimum, creaLuxPrimaUndaPerfectissima, etc.) devem ser coladas aqui da versão anterior.
    // Para abreviar, assumimos que elas estão presentes.
    // Cole aqui o corpo das funções: initAetherCanvasPerfectissima, reddeAetherPerfectissima, manifestaPrincipiumPerfectissimum, creaLuxPrimaUndaPerfectissima,
    // creaIgnisDivinusPerfectissima, creaChorusAngelorumPerfectissimus, creaSophiaNebulaPerfectissima, creaGratiaFlumenPerfectissimum, creaOrdoSigillumPerfectissimum.
    // O código abaixo já assume que elas existem.

    /* ---- ORCHESTRATIO ET CICLO AETERNO ---- */

    function purgaTheatrum() {
        M_DIVINITAS.intervalorumId.forEach(id => clearInterval(id));
        M_DIVINITAS.intervalorumId.clear();

        // Faz um fade out gracioso dos elementos existentes
        const elementosAtuais = Array.from(D_ELEMENTA.theatrum.children);
        elementosAtuais.forEach(el => {
            if (el.id !== 'principium-incognitum') {
                 if (typeof el.animate === 'function') {
                    el.animate([{ opacity: getComputedStyle(el).opacity }, { opacity: 0 }], { duration: 3000, easing: 'ease-in' })
                      .onfinish = () => el.remove();
                 } else {
                     el.remove();
                 }
            }
        });
        
        const logosAtuais = Array.from(D_ELEMENTA.logosThronus.children);
        logosAtuais.forEach(el => el.remove());

        M_DIVINITAS.elementaActiva.clear();
    }

    function initiaReditumAnagogicumPerfectissimum() {
        if (!M_DIVINITAS.activa) return;
        M_DIVINITAS.activa = false; // Pausa a criação de novos elementos

        purgaTheatrum();
        
        const p = document.getElementById('principium-incognitum');
        if (p) {
             p.animate([
                { opacity: getComputedStyle(p).opacity || 1, transform: getComputedStyle(p).transform, filter: getComputedStyle(p).filter, boxShadow: getComputedStyle(p).boxShadow },
                { opacity: 1, transform: 'translate3d(-50%, -50%, -1000px) scale(30)', filter: 'brightness(100) saturate(0)', boxShadow: '0 0 2000px 1000px var(--scintilla-prima)', offset: 0.7 },
                { opacity: 0, transform: 'translate3d(-50%, -50%, 0px) scale(0.0001)', filter: 'brightness(0)', boxShadow: 'none', offset: 1 }
            ], {
                duration: 15000, easing: 'cubic-bezier(0.7, 0, 0.84, 0)', fill: 'forwards'
            }).onfinish = () => {
                if(p.parentNode) p.remove();
                // REINICIA O CICLO
                setTimeout(initiaTheophaniamPerfectissimam, 5000);
            };
        } else {
            // Se o Principium não existir, apenas reinicia.
             setTimeout(initiaTheophaniamPerfectissimam, 5000);
        }
    }

    function manifestaLogosPerfectissima(d = 0) { 
        if (!M_DIVINITAS.activa) return;

        if (M_DIVINITAS.idxLogos >= K_LOGOS_ULTRA_PERFECTISSIMA.length) {
            initiaReditumAnagogicumPerfectissimum();
            return; 
        }

        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const lD = K_LOGOS_ULTRA_PERFECTISSIMA[M_DIVINITAS.idxLogos];
            const vC = document.createElement('div'); vC.classList.add('verbum-container');
            // ... (código de criação do verbum-container como antes)
            // ...
            D_ELEMENTA.logosThronus.appendChild(vC);
            M_DIVINITAS.idxLogos++;

            vC.addEventListener('animationend',()=>{ 
                if(vC.parentNode)vC.remove(); 
                if (M_DIVINITAS.activa) manifestaLogosPerfectissima(lD.t.length > 20 ? 3500 : 2800);
            });
            
            exsecuteEffectusSpecificus(lD.es, lD.ai);
            // ... (código de criação de efeitos genéricos do logos como antes)
            // ...

        }, d);
    }
    
    function initiaTheophaniamPerfectissimam() {
        purgaTheatrum();
        M_DIVINITAS.activa = true;
        M_DIVINITAS.idxLogos = 0;

        // Recria o Principium
        const principium = document.createElement('div');
        principium.id = 'principium-incognitum';
        D_ELEMENTA.theatrum.appendChild(principium);

        manifestaPrincipiumPerfectissimum();
        
        // Reinicia os fluxos contínuos de partículas
        const tasks = [
            { f: () => creaIgnisDivinusPerfectissima(0, K_DIVINI_MODI.RAND(0.8, 2.0)), i: 150 },
            { f: () => creaChorusAngelorumPerfectissimus(0, K_DIVINI_MODI.CHOICE(['seraphim', 'cherubim', 'thrones', 'virtus']), {x:K_DIVINI_MODI.RAND(10,90),y:K_DIVINI_MODI.RAND(10,90),z:K_DIVINI_MODI.RAND(-1200,1200)}, {radMin:400,radMax:2200,velMin:0.3,velMax:2.0,numPart:1,trailLength:K_DIVINI_MODI.RAND(5,12)}), i: 2000 },
            { f: () => creaSophiaNebulaPerfectissima(0), i: 15000 },
            { f: () => creaGratiaFlumenPerfectissimum(0), i: 12000 }
        ];

        tasks.forEach(task => {
            const id = setInterval(() => {
                if (M_DIVINITAS.activa) task.f();
            }, task.i);
            M_DIVINITAS.intervalorumId.add(id);
        });

        // Inicia a sequência do Logos
        setTimeout(() => manifestaLogosPerfectissima(), 10000);
    }


    /* ---- PONTO DE ENTRADA PRINCIPAL ---- */

    document.addEventListener('DOMContentLoaded',()=>{
        // Cole aqui todo o corpo das funções de criação que foram omitidas por abreviação
        // initAetherCanvasPerfectissima, reddeAetherPerfectissima, manifestaPrincipiumPerfectissimum, etc.
        
        initAetherCanvasPerfectissima();
        M_DIVINITAS.idFrameAnim = requestAnimationFrame(ansaAnimMagistraPerfectissima);
        D_ELEMENTA.btnVisioPlena.addEventListener('click',()=>{
            const e=document.documentElement;
            if(!document.fullscreenElement){
                if(e.requestFullscreen)e.requestFullscreen().catch(err => console.error(err.message));
                else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();
            }
        });

        const bodyStyle = getComputedStyle(document.body);
        const totalIntroTime = (parseFloat(bodyStyle.animationDelay.replace('s','')) + parseFloat(bodyStyle.animationDuration.replace('s',''))) * 1000;
        setTimeout(initiaTheophaniamPerfectissimam, Math.max(0, totalIntroTime - 2000));
    });

    function ansaAnimMagistraPerfectissima(t){
        if(!M_DIVINITAS.tmpUltimum) M_DIVINITAS.tmpUltimum = t;
        reddeAetherPerfectissima(t);
        M_DIVINITAS.idFrameAnim = requestAnimationFrame(ansaAnimMagistraPerfectissima);
    }

        /* ---- INITIALIZATIO ET REDDITIO AETHERIS (IMPLEMENTATIO ABSOLUTA) ---- */
    function initAetherCanvasPerfectissima(){
        const { bgCanvas: c, bgCtx: ctx } = D_ELEMENTA;
        c.width = window.innerWidth; c.height = window.innerHeight;
        M_DIVINITAS.particulaeAetheris = [];
        for(let i=0; i<M_DIVINITAS.MAX_PART_AETHERIS_ULTRA; i++){
            M_DIVINITAS.particulaeAetheris.push({
                x: Math.random() * c.width, y: Math.random() * c.height,
                vx: K_DIVINI_MODI.RAND(-0.05, 0.05), vy: K_DIVINI_MODI.RAND(-0.05, 0.05),
                r: K_DIVINI_MODI.RAND(0.1, 0.8),
                o: K_DIVINI_MODI.RAND(0.1, 0.7),
                vo: K_DIVINI_MODI.RAND(0.001, 0.005) * (Math.random() > 0.5 ? 1 : -1),
                c: `rgba(255, 255, 255, ${K_DIVINI_MODI.RAND(0.2, 0.8)})`
            });
        }
    }
    function reddeAetherPerfectissima(t){
        const { bgCanvas: c, bgCtx: ctx } = D_ELEMENTA;
        ctx.clearRect(0,0,c.width,c.height);
        M_DIVINITAS.particulaeAetheris.forEach(p=>{
            p.x += p.vx; p.y += p.vy; p.o += p.vo;
            if(p.x<0||p.x>c.width) p.vx*=-1;
            if(p.y<0||p.y>c.height) p.vy*=-1;
            if(p.o<0.1||p.o>0.7) p.vo*=-1;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, K_DIVINI_MODI.TWO_PI);
            ctx.fillStyle = p.c.replace(/[\d\.]+\)$/, `${p.o})`);
            ctx.fill();
        });
    }
    window.addEventListener('resize',initAetherCanvasPerfectissima);

    /* ---- MANIFESTATIO PRINCIPII INCOGNITI (PERFECTISSIMA) ---- */
    function manifestaPrincipiumPerfectissimum(){
        const p = D_ELEMENTA.principium;
        if (!p) return;
        p.animate([
            { opacity: 0, transform: 'translate3d(-50%, -50%, -1500px) scale(0.0001)', boxShadow: '0 0 0px 0px var(--scintilla-prima)', filter: 'brightness(0.5)'},
            { opacity: 0.9, transform: 'translate3d(-50%, -50%, -100px) scale(0.05)', boxShadow: `0 0 15px 3px var(--scintilla-prima), 0 0 30px 7px var(--pleroma-alba-margarita)`, filter: 'brightness(8)', offset: 0.05 },
            { opacity: 1, transform: 'translate3d(-50%, -50%, 150px) scale(8)', boxShadow: `0 0 250px 125px var(--scintilla-prima), 0 0 500px 250px var(--lux-increata-effulgentia), 0 0 800px 400px var(--lumen-divinum-aurum), 0 0 1400px 700px var(--pleroma-alba-margarita)`, filter: 'brightness(30) saturate(1.5)', offset: 0.12 },
            { opacity: 0.98, transform: 'translate3d(-50%, -50%, 0px) scale(1)', boxShadow: `0 0 40px 10px var(--scintilla-prima), 0 0 80px 25px var(--lux-increata-effulgentia), 0 0 150px 50px var(--lumen-divinum-aurum)`, filter: 'brightness(4) saturate(1.1)', offset: 0.30 },
            { opacity: 0.98, transform: 'translate3d(-50%, -50%, 0px) scale(1)', boxShadow: `0 0 40px 10px var(--scintilla-prima), 0 0 80px 25px var(--lux-increata-effulgentia), 0 0 150px 50px var(--lumen-divinum-aurum)`, filter: 'brightness(4) saturate(1.1)' }
        ], { duration: (K_TEMPORA_PERFECTISSIMA.princRad - K_TEMPORA_PERFECTISSIMA.princEmerg) + 2500, easing: 'cubic-bezier(0.65, 0, 0.35, 1)', fill: 'forwards' });
        setTimeout(()=>{ if(!M_DIVINITAS.activa)return; p.style.animation="principiumPulsatioDivinaUltra 25s cubic-bezier(0.455,0.03,0.515,0.955) infinite alternate"; D_ELEMENTA.theatrum.insertAdjacentHTML('beforeend',`<style>@keyframes principiumPulsatioDivinaUltra{0%{opacity:0.92;transform:translate3d(-50%,-50%,-15px) scale(0.92);filter:brightness(3.8);box-shadow:0 0 35px 8px var(--scintilla-prima),0 0 70px 20px var(--lux-increata-effulgentia),0 0 130px 42px var(--lumen-divinum-aurum);}100%{opacity:1;transform:translate3d(-50%,-50%,15px) scale(1.08);filter:brightness(4.2);box-shadow:0 0 45px 12px var(--scintilla-prima),0 0 90px 28px var(--lux-increata-effulgentia),0 0 170px 55px var(--lumen-divinum-aurum);}}</style>`);},(K_TEMPORA_PERFECTISSIMA.princRad-K_TEMPORA_PERFECTISSIMA.princEmerg)+2500);
    }
        // setTimeout(manifestaPrincipiumPerfectissimum, K_TEMPORA_PERFECTISSIMA.princEmerg); // Commented out as per new logic


    /* ---- FUNCTIONES CREATIONIS ELEMENTORUM DIVINORUM (IMPLEMENTATIONES ABSOLUTAE ET PERFECTISSIMAE) ---- */

    /* LUX PRIMA UNDA (PERFECTISSIMA) */
    function creaLuxPrimaUndaPerfectissima(d, opts = {}) {
        const { colorOverride, scaleMultiplier = 1, durationMultiplier = 1, blurMultiplier = 1, zOffsetMultiplier = 1, origin = null } = opts;
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const u = document.createElement('div'); u.classList.add('lux-prima-unda'); M_DIVINITAS.elementaActiva.add(u);
            const pRect = origin ? origin.getBoundingClientRect() : D_ELEMENTA.principium.getBoundingClientRect();
            const tRect = D_ELEMENTA.theatrum.getBoundingClientRect();
            u.style.top = `${pRect.top - tRect.top + pRect.height/2}px`; u.style.left = `${pRect.left - tRect.left + pRect.width/2}px`;
            const s = K_DIVINI_MODI.RAND(3,15) * scaleMultiplier; u.style.width=`${s}px`; u.style.height=`${s}px`;
            const iZ = K_DIVINI_MODI.RAND(-150,150) * zOffsetMultiplier; let iT = `translate3d(-50%,-50%,${iZ}px) scale(0.0005)`; u.style.transform = iT;
            u.style.borderColor = colorOverride || `hsla(${K_DIVINI_MODI.RAND(0,360)}, 100%, ${K_DIVINI_MODI.RAND(90,100)}%, ${K_DIVINI_MODI.RAND(0.6,1)})`;
            u.style.borderWidth = `${K_DIVINI_MODI.RAND(0.15,0.4)}px`; u.style.filter = `blur(${0.2*blurMultiplier}px) brightness(${K_DIVINI_MODI.RAND(2,3.5)})`;
            D_ELEMENTA.theatrum.appendChild(u);
            const mS = K_DIVINI_MODI.RAND(50,90) * scaleMultiplier; const dur = K_DIVINI_MODI.RAND(4500,8000) * durationMultiplier; const fZ = iZ + K_DIVINI_MODI.RAND(-700,700) * zOffsetMultiplier;
            let kfs = [
                { opacity:0, transform:iT, filter:u.style.filter },
                { opacity:K_DIVINI_MODI.RAND(0.7,1), filter:`blur(${0.15*blurMultiplier}px) brightness(${K_DIVINI_MODI.RAND(3,5)})`, offset:0.01 },
                { opacity:0, transform:`translate3d(-50%,-50%,${fZ}px) scale(${mS})`, filter:`blur(${1.8*blurMultiplier}px) brightness(0.7)`, borderWidth:'0px', offset:1 }
            ];
            u.animate(kfs, {duration:dur, easing:'cubic-bezier(0.12, 0.75, 0.2, 1)', iterations:1}).onfinish = () => { if(u.parentNode) u.remove(); M_DIVINITAS.elementaActiva.delete(u); };
        }, d);
    }

    /* IGNIS DIVINUS SCINTILLA (PERFECTISSIMA) */
    function creaIgnisDivinusPerfectissima(d, iT = 1, originEl = null) {
        setTimeout(() => {
            if(!M_DIVINITAS.activa) return;
            const ig=document.createElement('div'); ig.classList.add('ignis-divinus-scintilla-ultra'); M_DIVINITAS.elementaActiva.add(ig);
            const bS=K_DIVINI_MODI.RAND(0.4,2.0)*iT; ig.style.width=`${bS}px`; ig.style.height=`${bS}px`;
            const cCVal = K_DIVINI_MODI.CHOICE(['var(--scintilla-prima)','var(--lumen-divinum-aurum)','var(--lumen-amoris-ignis)','var(--lumen-seraphicum-flamma)', 'var(--pleroma-alba-margarita)']);
            ig.style.backgroundColor=cCVal;
            ig.style.boxShadow=`0 0 ${bS*2}px ${cCVal}, 0 0 ${bS*4}px ${cCVal.replace('var(','rgba(').replace(')',`,0.75)`)}, 0 0 ${bS*7}px ${K_DIVINI_MODI.CHOICE(['var(--lux-increata-effulgentia)','var(--pleroma-alba-margarita)'])}, 0 0 ${bS*12}px rgba(255,255,255,0.15)`;
            let sX, sY, sZ;
            if(originEl){ const oRect=originEl.getBoundingClientRect(),tRect=D_ELEMENTA.theatrum.getBoundingClientRect(); sX=(oRect.left-tRect.left+oRect.width/2); sY=(oRect.top-tRect.top+oRect.height/2); sZ=parseFloat(getComputedStyle(originEl).transform.split(',')[14] || K_DIVINI_MODI.RAND(-100,100)); }
            else{ sX=K_DIVINI_MODI.RAND(0.05*innerWidth, 0.95*innerWidth); sY=K_DIVINI_MODI.RAND(0.05*innerHeight, 0.95*innerHeight); sZ=K_DIVINI_MODI.RAND(-500,500); }
            ig.style.left=`${sX}px`; ig.style.top=`${sY}px`; ig.style.transform=`translate3d(-50%,-50%,${sZ}px) scale(0.15)`;
            const nTS=2+Math.floor(bS*2);
            for(let i=0;i<nTS;i++){const tS=document.createElement('div');tS.classList.add('ignis-trail-segment');const sO=0.7-i*(0.65/nTS);tS.style.background=`radial-gradient(ellipse at center,${cCVal.replace('var(','rgba(').replace(')',`,${sO*0.9})`)} 0%,transparent 60%)`;tS.style.filter=`blur(${i*0.25*iT}px) brightness(${1+(nTS-i)*0.15})`;const sF=1-i*(0.75/nTS);tS.style.transform=`scale(${sF}) translateZ(${-i*bS*1.5}px)`;ig.appendChild(tS);}
            D_ELEMENTA.theatrum.appendChild(ig);
            const pD=K_DIVINI_MODI.RAND(1200,2800)/(iT*0.6+0.4); const kP=[{opacity:0,transform:ig.style.transform,filter:`brightness(${iT*1.2})`,offset:0}];
            let cX=sX, cY=sY, cZ=sZ; const nPoints=2+Math.floor(iT*1.5);
            for(let i=1;i<=nPoints;i++){
                const nX=cX+K_DIVINI_MODI.RAND(-60,60)*iT, nY=cY+K_DIVINI_MODI.RAND(-60,60)*iT, nZ=cZ+K_DIVINI_MODI.RAND(-300,300)*iT;
                if(i===1) kP.push({opacity:1,transform:`translate3d(-50%,-50%,0) translate3d(${nX}px,${nY}px,${nZ}px) scale(1)`,filter:`brightness(${K_DIVINI_MODI.RAND(4,8)*iT})`,offset:0.015});
                else kP.push({opacity:K_DIVINI_MODI.RAND(0.5,1),transform:`translate3d(-50%,-50%,0) translate3d(${nX}px,${nY}px,${nZ}px) scale(${1-i*(0.75/nPoints)})`,filter:`brightness(${K_DIVINI_MODI.RAND(2.5,6)*iT})`,offset:i*(0.95/nPoints)});
                cX=nX; cY=nY; cZ=nZ;
            }
            kP.push({opacity:0,transform:`translate3d(-50%,-50%,0) translate3d(${cX+K_DIVINI_MODI.RAND(-100,100)*iT}px,${cY+K_DIVINI_MODI.RAND(-100,100)*iT}px,${cZ+K_DIVINI_MODI.RAND(-100,100)*iT}px) scale(0.001)`,filter:'brightness(1)',offset:1});
            ig.animate(kP,{duration:pD,easing:'cubic-bezier(0.215, 0.61, 0.355, 1)'}).onfinish=()=>{if(ig.parentNode)ig.remove();M_DIVINITAS.elementaActiva.delete(ig);};
        },d);
    }

    /* CHORI ANGELORUM (PERFECTISSIMI) */
    function creaChorusAngelorumPerfectissimus(d, cT="dominatio", bP={x:50,y:50,z:0}, oP={radMin:200,radMax:1000,velMin:0.3,velMax:1.8,compMin:3,compMax:8,numPart:1, auraLayers:1, trailLength:0}){
        const bX_px = bP.x / 100 * innerWidth;
        const bY_px = bP.y / 100 * innerHeight;
        for(let k=0; k<oP.numPart; k++){
            setTimeout(() => {
                if (!M_DIVINITAS.activa) return;
                const p = document.createElement('div'); p.classList.add('angelorum-chorus-particula'); M_DIVINITAS.elementaActiva.add(p);
                let pColor, pSize, pShadow, pAuraColors=[], pTrailGrad, pDur = K_DIVINI_MODI.RAND(15000,35000) / K_DIVINI_MODI.RAND(oP.velMin,oP.velMax);
                switch(cT){
                    case 'seraphim': pColor='var(--lumen-seraphicum-flamma)';pSize=K_DIVINI_MODI.RAND(3,6);pShadow=`0 0 ${pSize*2}px ${pColor},0 0 ${pSize*4}px var(--lumen-amoris-ignis)`; pAuraColors=[`rgba(255,119,0,0.3)`,`rgba(255,0,0,0.15)`]; pTrailGrad=`linear-gradient(to right,transparent,rgba(255,119,0,0.7) 30%,rgba(255,223,0,0.5) 70%,transparent)`; break;
                    case 'cherubim': pColor='var(--lumen-cherubicum-caeruleum)';pSize=K_DIVINI_MODI.RAND(2.5,5);pShadow=`0 0 ${pSize*2}px ${pColor},0 0 ${pSize*4}px var(--lumen-sapientiae-sapphirus)`;pAuraColors=[`rgba(65,105,225,0.25)`,`rgba(175,238,238,0.1)`]; pTrailGrad=`linear-gradient(to right,transparent,rgba(65,105,225,0.6) 30%,rgba(240,248,255,0.4) 70%,transparent)`; break;
                    case 'thrones':  pColor='var(--lumen-thronorum-crystallus)';pSize=K_DIVINI_MODI.RAND(3.5,7);pShadow=`0 0 ${pSize*3}px ${pColor},0 0 ${pSize*6}px var(--scintilla-prima)`;pAuraColors=[`rgba(175,238,238,0.35)`,`rgba(255,255,255,0.2)`]; pTrailGrad=`linear-gradient(to right,transparent,rgba(175,238,238,0.8) 30%,rgba(255,255,255,0.6) 70%,transparent)`; break;
                    default: pColor=K_DIVINI_MODI.CHOICE(['var(--vestigia-dei-amethystus)','var(--anima-cosmica-smaragdus)']);pSize=K_DIVINI_MODI.RAND(2,4);pShadow=`0 0 ${pSize*1.5}px ${pColor},0 0 ${pSize*3}px var(--pleroma-alba-margarita)`;pAuraColors=[pColor.replace('var(','rgba(').replace(')',',0.2)'), `rgba(250,240,230,0.1)`]; pTrailGrad=`linear-gradient(to right,transparent,${pColor.replace('var(','rgba(').replace(')',',0.5)')} 40%,transparent)`;
                }
                p.style.width=`${pSize}px`;p.style.height=`${pSize}px`;p.style.backgroundColor=pColor;p.style.boxShadow=pShadow;
                p.style.left=`${bX_px}px`;p.style.top=`${bY_px}px`;
                for(let i=0;i<oP.auraLayers;i++){const au=document.createElement('div');au.classList.add('particula-aura-divina');au.style.width=`${pSize*(2+i*1.5)}px`;au.style.height=`${pSize*(2+i*1.5)}px`;au.style.background=`radial-gradient(ellipse at center,transparent 30%,${pAuraColors[i%pAuraColors.length]} 70%)`;au.style.opacity=K_DIVINI_MODI.RAND(0.3,0.7)/(i+1);au.style.transform=`translate(-50%,-50%) translateZ(${-i*pSize*0.5}px)`;p.appendChild(au);}
                let ca = null; if(oP.trailLength > 0){ca=document.createElement('div');ca.classList.add('particula-cometa-cauda');ca.style.width=`${pSize*oP.trailLength}px`;const nCS=Math.max(1,Math.floor(oP.trailLength/3));for(let i=0;i<nCS;i++){const cs=document.createElement('div');cs.classList.add('cauda-stratum');cs.style.background=pTrailGrad;cs.style.opacity=0.8-i*(0.7/nCS);cs.style.transform=`scaleY(${1-i*(0.8/nCS)}) translateZ(${-i*pSize*0.1}px)`;ca.appendChild(cs);} p.appendChild(ca);}
                D_ELEMENTA.theatrum.appendChild(p);
                const kf=[{opacity:0,transform:`translate3d(-50%,-50%,0) translateZ(${bP.z || 0}px) scale(0.1)`,offset:0}];let cA=K_DIVINI_MODI.RAND(0,K_DIVINI_MODI.TWO_PI),cR,cZ,x,y;
                let lastX=0, lastY=0;
                const nW=K_DIVINI_MODI.RAND_INT(oP.compMin,oP.compMax);
                for(let i=1;i<=nW;i++){
                    cA+=K_DIVINI_MODI.RAND(-K_DIVINI_MODI.TWO_PI/2.5,K_DIVINI_MODI.TWO_PI/2.5);cR=K_DIVINI_MODI.RAND(oP.radMin,oP.radMax);cZ=(bP.z||0)+K_DIVINI_MODI.RAND(-oP.radMax/1.5,oP.radMax/1.5);
                    x=Math.cos(cA)*cR; y=Math.sin(cA)*cR*K_DIVINI_MODI.RAND(0.6,1.4);
                    const angle_rad = Math.atan2(y - lastY, x - lastX);
                    const trail_rot = `rotate(${angle_rad * 180 / Math.PI}deg)`;
                    const pT=`translate3d(-50%,-50%,0) translate3d(${x}px,${y}px,${cZ}px) scale(${K_DIVINI_MODI.RAND(0.9,1.1)}) rotateX(${K_DIVINI_MODI.RAND(-30,30)}deg) rotateY(${K_DIVINI_MODI.RAND(-30,30)}deg)`;
                    const frame = {opacity:K_DIVINI_MODI.RAND(0.8,1), transform:pT, offset:(i/nW)*0.9+0.03};
                    if (ca) frame.offset = (i/nW);
                    if(i===1) kf.push({opacity:1,transform:pT,offset:0.03}); else kf.push(frame);
                    if (ca) ca.style.transform = trail_rot;
                    lastX = x; lastY = y;
                }
                const lastFrame = kf[kf.length-1];
                kf.push({opacity:0,transform:lastFrame.transform.replace(/scale\([^)]+\)/,`scale(0.05)`),offset:1});
                p.animate(kf,{duration:pDur,easing:'cubic-bezier(0.37, 0, 0.63, 1)',delay:d+k*K_DIVINI_MODI.RAND(50,150)}).onfinish=()=>{if(p.parentNode)p.remove();M_DIVINITAS.elementaActiva.delete(p);};
            },0);
        }
    }

    /* SOPHIA NEBULA MAJESTAS (PERFECTISSIMA) */
    function creaSophiaNebulaPerfectissima(d){
        setTimeout(()=>{
            if(!M_DIVINITAS.activa)return;
            const n=document.createElement('div');n.classList.add('sophia-nebula-majestas');M_DIVINITAS.elementaActiva.add(n);
            const bS=K_DIVINI_MODI.RAND(Math.min(innerWidth,innerHeight)*0.5,Math.min(innerWidth,innerHeight)*1.2);
            n.style.width=`${bS}px`;n.style.height=`${bS*K_DIVINI_MODI.RAND(0.4,0.9)}px`;
            n.style.top=`${K_DIVINI_MODI.RAND(-10,110)}%`;n.style.left=`${K_DIVINI_MODI.RAND(-10,110)}%`;
            const c={am: `rgba(138,43,226,${K_DIVINI_MODI.RAND(0.03,0.15)})`,em: `rgba(0,128,128,${K_DIVINI_MODI.RAND(0.03,0.15)})`,
                     p: `rgba(250,240,230,${K_DIVINI_MODI.RAND(0.05,0.2)})`,g: `rgba(255,223,0,${K_DIVINI_MODI.RAND(0.02,0.12)})`,
                     s: `rgba(10,42,127,${K_DIVINI_MODI.RAND(0.02,0.1)})`,ro: `rgba(255,182,193,${K_DIVINI_MODI.RAND(0.04,0.12)})`};
            n.style.background=`
                radial-gradient(ellipse at ${K_DIVINI_MODI.RAND(10,30)}% ${K_DIVINI_MODI.RAND(10,30)}%, ${c.s} 0%, transparent 50%),
                radial-gradient(ellipse at ${K_DIVINI_MODI.RAND(70,90)}% ${K_DIVINI_MODI.RAND(10,30)}%, ${c.g} 0%, transparent 45%),
                radial-gradient(ellipse at ${K_DIVINI_MODI.RAND(10,30)}% ${K_DIVINI_MODI.RAND(70,90)}%, ${c.ro} 0%, transparent 40%),
                radial-gradient(ellipse at ${K_DIVINI_MODI.RAND(70,90)}% ${K_DIVINI_MODI.RAND(70,90)}%, ${c.em} 0%, transparent 55%),
                radial-gradient(ellipse at center, ${c.p} 0%, ${c.am} 15%, ${c.em} 30%, ${c.s} 50%, transparent 70%)`;
            n.style.backgroundSize="250% 250%, 200% 200%, 300% 300%, 180% 180%, 350% 350%";
            n.style.animationDuration=`${K_DIVINI_MODI.RAND(250,400)}s, ${K_DIVINI_MODI.RAND(180,280)}s, ${K_DIVINI_MODI.RAND(35,55)}s`;
            D_ELEMENTA.theatrum.appendChild(n);
            const initialTransform = `translate3d(-50%, -50%, ${K_DIVINI_MODI.RAND(-500,-200)}px) scale(0.2) rotateZ(${K_DIVINI_MODI.RAND(-90,90)}deg)`;
            n.animate([
                {opacity:0, transform: initialTransform},
                {opacity:K_DIVINI_MODI.RAND(0.6,0.95), offset:0.15}, {opacity:K_DIVINI_MODI.RAND(0.5,0.8), offset:0.85},
                {opacity:0, transform: `translate3d(-50%, -50%, ${K_DIVINI_MODI.RAND(200,500)}px) scale(1.3) rotateZ(${K_DIVINI_MODI.RAND(90,270)}deg)`}
            ], {duration:K_DIVINI_MODI.RAND(35000,60000),easing:'ease-in-out'}).onfinish=()=>{if(n.parentNode)n.remove();M_DIVINITAS.elementaActiva.delete(n);};
        },d);
    }

    /* GRATIA FLUMEN MAGNUM (PERFECTISSIMUM) */
    function creaGratiaFlumenPerfectissimum(d){
        setTimeout(()=>{
            if(!M_DIVINITAS.activa)return;
            const r=document.createElement('div'); r.classList.add('gratia-flumen-magnum'); M_DIVINITAS.elementaActiva.add(r);
            const sY=K_DIVINI_MODI.RAND(-10,110), sX_val=K_DIVINI_MODI.RAND(0,1)>0.5?-10:110, eX_val = sX_val > 50 ? -10 : 110;
            let path = `M ${sX_val}vw ${sY}vh`; const nSegs = K_DIVINI_MODI.RAND_INT(2,5); let prevX=sX_val, prevY=sY;
            for(let i=0;i<nSegs;i++){
                const c1X=prevX+K_DIVINI_MODI.RAND(-20,20), c1Y=prevY+K_DIVINI_MODI.RAND(-40,40),
                      c2X=K_DIVINI_MODI.RAND(10,90), c2Y=K_DIVINI_MODI.RAND(0,100),
                      eX=K_DIVINI_MODI.RAND(10,90), eY=K_DIVINI_MODI.RAND(0,100);
                path+=` C ${c1X}vw ${c1Y}vh, ${c2X}vw ${c2Y}vh, ${eX}vw ${eY}vh`;
                prevX=eX; prevY=eY;
            }
            path+=` L ${eX_val}vw ${K_DIVINI_MODI.RAND(-10,110)}vh`;
            r.style.offsetPath = `path("${path}")`;
            r.style.width = `1px`; r.style.height = `${K_DIVINI_MODI.RAND(1.5,3.5)}px`;
            const gradColors = [ `var(--lumen-divinum-aurum) 30%, var(--pleroma-alba-margarita) 50%, var(--lumen-divinum-aurum) 70%`, `var(--lumen-sapientiae-sapphirus) 30%, var(--scintilla-prima) 50%, var(--lumen-sapientiae-sapphirus) 70%`, `var(--anima-cosmica-smaragdus) 30%, var(--pleroma-alba-margarita) 50%, var(--anima-cosmica-smaragdus) 70%`];
            const chosenGrad = K_DIVINI_MODI.CHOICE(gradColors);
            r.style.background=`linear-gradient(to right, transparent, ${chosenGrad}, transparent)`;
            r.style.filter = `blur(1px) drop-shadow(0 0 8px ${chosenGrad.includes('FFDF00')?'var(--lumen-divinum-aurum)':'var(--pleroma-alba-margarita)'}) brightness(1.1)`;
            r.style.transform = `translateZ(${K_DIVINI_MODI.RAND(-200,200)}px) rotateY(${K_DIVINI_MODI.RAND(-15,15)}deg)`;
            D_ELEMENTA.theatrum.appendChild(r);
            r.animate([{offsetDistance:'0%',opacity:0},{offsetDistance:'5%',opacity:K_DIVINI_MODI.RAND(0.7,1),offset:0.05},{offsetDistance:'95%',opacity:K_DIVINI_MODI.RAND(0.6,0.9),offset:0.95},{offsetDistance:'100%',opacity:0}],
            {duration:K_DIVINI_MODI.RAND(18000,30000), easing:'cubic-bezier(0.4, 0, 0.6, 1)'}).onfinish=()=>{if(r.parentNode)r.remove();M_DIVINITAS.elementaActiva.delete(r);};
            
            const numRiverParticles = K_DIVINI_MODI.RAND_INT(15,30);
            for(let i=0; i<numRiverParticles; i++){
                const rp = document.createElement('div'); rp.classList.add('flumen-particula-undae');
                rp.style.backgroundColor = K_DIVINI_MODI.CHOICE(['var(--pleroma-alba-margarita)', 'var(--lumen-divinum-aurum)']);
                rp.style.boxShadow = `0 0 3px ${rp.style.backgroundColor}`; rp.style.opacity=0;
                rp.style.offsetPath = `path("${path}")`;
                r.appendChild(rp);
                rp.animate([
                    {offsetDistance:`${K_DIVINI_MODI.RAND(0,10)}%`, opacity:0, transform:`scale(${K_DIVINI_MODI.RAND(0.5,1.2)}) translateY(${K_DIVINI_MODI.RAND(-2,2)}px)`},
                    {opacity:K_DIVINI_MODI.RAND(0.5,0.9), offset:0.1},
                    {opacity:K_DIVINI_MODI.RAND(0.4,0.8), offset:0.9},
                    {offsetDistance:`${K_DIVINI_MODI.RAND(90,100)}%`, opacity:0}
                ], {duration:K_DIVINI_MODI.RAND(5000,10000), delay:K_DIVINI_MODI.RAND(0,15000), iterations:Infinity, easing:'linear'});
            }
        },d);
    }

    /* ORDO CREATIONIS SIGILLUM (PERFECTISSIMUM) */
    function creaOrdoSigillumPerfectissimum(d, lD){
        setTimeout(() => {
            if(!M_DIVINITAS.activa) return;
            const sC = document.createElement('div'); sC.classList.add('ordo-creationis-sigillum'); M_DIVINITAS.elementaActiva.add(sC);
            const iL = lD.ai * K_DIVINI_MODI.RAND(0.8,1.2);
            const bR = 120 + iL * 40;
            const initialTransform = `translate3d(-50%,-50%,${K_DIVINI_MODI.RAND(-200,200)}px) rotateX(${K_DIVINI_MODI.RAND(-90,90)}deg) rotateY(${K_DIVINI_MODI.RAND(-90,90)}deg) rotateZ(${K_DIVINI_MODI.RAND(-180,180)}deg)`;
            sC.style.transform = initialTransform;
            D_ELEMENTA.theatrum.appendChild(sC);

            function genStratum(parent, depth, maxDepth, radius, angleOffset, numSegs, colorBase) {
                if (depth > maxDepth || radius < 5) return;
                const opacityBase = 0.5 - (depth * 0.1);
                for (let i=0; i<numSegs; i++) {
                    const stratum = document.createElement('div'); stratum.classList.add('sigillum-stratum');
                    const ang = angleOffset + (i * (360/numSegs));
                    const len = radius * K_DIVINI_MODI.RAND(0.3, 0.7);
                    stratum.style.width = `${len}px`; stratum.style.height = `${K_DIVINI_MODI.RAND(0.2, 0.6)}px`;
                    const x = Math.cos(ang*K_DIVINI_MODI.DEG_AD_RAD)*radius*0.5; const y = Math.sin(ang*K_DIVINI_MODI.DEG_AD_RAD)*radius*0.5;
                    const z = K_DIVINI_MODI.RAND(-radius*0.4,radius*0.4) * (depth/maxDepth);
                    const currentDepthColor = `hsla(${colorBase + depth*25}, 85%, ${75 - depth*12}%, ${opacityBase*K_DIVINI_MODI.RAND(0.7,1)})`;
                    stratum.style.borderColor = currentDepthColor;
                    stratum.style.boxShadow = `0 0 ${Math.max(1,3-depth)}px ${currentDepthColor.replace('hsla(','rgba(').replace(/,[^,]+?\)/,',0.5)')}`;
                    const initialStratumTransform = `translate3d(${x}px,${y}px,${z}px) rotateZ(${ang+90}deg) rotateX(${K_DIVINI_MODI.RAND(-75,75)}deg) rotateY(${K_DIVINI_MODI.RAND(-75,75)}deg) scale(0.1)`;
                    stratum.style.transform = initialStratumTransform;
                    parent.appendChild(stratum);
                    stratum.animate([
                        {transform:initialStratumTransform, opacity:0},
                        {transform:initialStratumTransform.replace('scale(0.1)','scale(1)'), opacity:1, offset:0.1 + depth*0.05},
                        {transform:initialStratumTransform.replace('scale(0.1)',`scale(${K_DIVINI_MODI.RAND(1.1,1.3)}) rotateZ(${K_DIVINI_MODI.RAND(-15,15)}deg)`), opacity:K_DIVINI_MODI.RAND(0.3,0.7), offset: 0.8 + depth*0.02},
                        {transform:initialStratumTransform.replace('scale(0.1)',`scale(0.05) rotateZ(${K_DIVINI_MODI.RAND(-30,30)}deg)`), opacity:0, offset:1}
                    ],{duration:K_DIVINI_MODI.RAND(3000,5000)+depth*500, easing:'cubic-bezier(0.16, 1, 0.3, 1)', delay:depth*150+i*30, fill:'forwards'});
                    if (numSegs > 2) genStratum(stratum, depth+1, maxDepth, radius*0.55, ang, Math.max(2,numSegs-1), colorBase+40);
                }
            }
            genStratum(sC, 1, Math.min(4, Math.floor(iL*1.2)), bR, K_DIVINI_MODI.RAND(0,360), Math.min(8, Math.floor(iL*2)+3), K_DIVINI_MODI.RAND(0,360));
            
            sC.animate([
                {opacity:0, transform:sC.style.transform+` scale3d(0.05,0.05,0.05)`},
                {opacity:K_DIVINI_MODI.RAND(0.6,1), offset:0.1}, {opacity:K_DIVINI_MODI.RAND(0.5,0.8),offset:0.9},
                {opacity:0, transform:sC.style.transform+` scale3d(0.01,0.01,0.01) rotateZ(180deg)`}
            ], {duration:K_DIVINI_MODI.RAND(6000,10000)*iL, easing:'ease-in-out'}).onfinish=()=>{if(sC.parentNode)sC.remove();M_DIVINITAS.elementaActiva.delete(sC);};
        },d);
    }
    
    // Placeholder function for specific effects not yet implemented
    function exsecuteEffectusSpecificus(effectName, intensity) {
        // This function can be expanded with unique visual events tied to specific logos
        // For now, it serves as a hook for future expansion.
        // Example: if (effectName === "fiatLuxCosmica") { /* create a massive flash */ }
    }
     // Placeholder for another unimplemented symbolic effect
    function creaSymbolaCosmica(d, intensity) { 
        /* Could generate things like filaments or spirals. */ 
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            // Create simple cosmic symbols as placeholders
            for (let i = 0; i < intensity * 3; i++) {
                creaLuxPrimaUndaPerfectissima(i * 200, { scaleMultiplier: intensity });
            }
        }, d);
    }

    /* FUNCTIO MANIFESTATIONIS LOGOS PERFECTISSIMA CUM EFFECTIBUS SPECIFICIS */
    function manifestaLogosPerfectissima(d = 0) { 
        if (!M_DIVINITAS.activa || M_DIVINITAS.idxLogos >= K_LOGOS_ULTRA_PERFECTISSIMA.length) {
            if (M_DIVINITAS.activa) setTimeout(initiaReditumAnagogicumPerfectissimum, Math.max(5000, K_TEMPORA_PERFECTISSIMA.reditusAnagogIncep - (Date.now() - M_DIVINITAS.paginaInitTimestamp)));
            return;
        }
        setTimeout(() => {
            if (!M_DIVINITAS.activa) return;
            const lD = K_LOGOS_ULTRA_PERFECTISSIMA[M_DIVINITAS.idxLogos]; M_DIVINITAS.txtLogosCurrens = lD.t;
            const vC = document.createElement('div'); vC.classList.add('verbum-container');
            const vP=document.createElement('div');vP.classList.add('verbum-principale');vP.textContent=lD.t;vP.style.fontFamily=lD.f;const bFSp=parseFloat(lD.sr)*10;vP.style.fontSize=`clamp(${bFSp*0.35}em,${bFSp*0.9}vw,${bFSp*1.3}em)`;vP.style.color=lD.c;vC.appendChild(vP);
            if(lD.gl){const vG=document.createElement('div');vG.classList.add('verbum-glosa-latina');vG.textContent=lD.gl;const gFSz=(parseFloat(vP.style.fontSize.match(/(\d*\.?\d*)vw/)?.[1]||bFSp*0.9*0.2))*0.2;vG.style.fontSize=`${Math.max(0.8,gFSz)}em`;vG.style.marginTop=`${Math.max(0.3,gFSz*0.2)}em`;vC.appendChild(vG);}
            vC.style.setProperty('--rand-rotY-start',`${K_DIVINI_MODI.RAND(-15,15)}deg`);vC.style.setProperty('--rand-rotX-end',`${K_DIVINI_MODI.RAND(-75,-65)}deg`);vC.style.setProperty('--rand-rotY-end',`${K_DIVINI_MODI.RAND(-10,10)}deg`);
            const animDuration = K_DIVINI_MODI.RAND(18,22) + (lD.dE||0)/1000;
            vC.style.animation=`verbumEmergentiaDivina ${animDuration}s cubic-bezier(0.22,0.61,0.36,1) forwards`;
            let rI=null;
            vC.addEventListener('animationstart',()=>{setTimeout(()=>{if(!vC||!M_DIVINITAS.activa){if(rI) clearInterval(rI);return;}rI=setInterval(()=>{if(!vC.parentNode||!M_DIVINITAS.activa){if(rI) clearInterval(rI);return;}vC.style.setProperty('--reverb-z',`${K_DIVINI_MODI.RAND(5,25)}px`);vC.style.setProperty('--reverb-scale',`${K_DIVINI_MODI.RAND(1.002,1.008)}`);vC.style.setProperty('--reverb-rotX',`${K_DIVINI_MODI.RAND(-0.8,0.3)}deg`);vC.style.setProperty('--reverb-rotY',`${K_DIVINI_MODI.RAND(-0.3,0.3)}deg`);vC.style.setProperty('--reverb-blur',`${K_DIVINI_MODI.RAND(0.1,0.5)}px`);vC.style.setProperty('--reverb-brightness',`${K_DIVINI_MODI.RAND(1.1,1.25)}`);},150);}, animDuration*1000*0.25);});
            D_ELEMENTA.logosThronus.appendChild(vC); M_DIVINITAS.elementaActiva.add(vC); M_DIVINITAS.idxLogos++;
            vC.addEventListener('animationend',()=>{ if(rI) clearInterval(rI); if(vC.parentNode)vC.remove(); M_DIVINITAS.elementaActiva.delete(vC); if(M_DIVINITAS.idxLogos<K_LOGOS_ULTRA_PERFECTISSIMA.length) manifestaLogosPerfectissima(lD.t.length>20?3500:2800); else setTimeout(initiaReditumAnagogicumPerfectissimum, Math.max(5000, K_TEMPORA_PERFECTISSIMA.reditusAnagogIncep - (Date.now() - M_DIVINITAS.paginaInitTimestamp)));});
            if(lD.es)exsecuteEffectusSpecificus(lD.es,lD.ai);
            creaOrdoSigillumPerfectissimum(K_DIVINI_MODI.RAND(600,1000)*(1/(lD.ai+0.1)),lD);
            for(let i=0;i<Math.ceil(lD.ai*8);i++)creaLuxPrimaUndaPerfectissima(K_DIVINI_MODI.RAND(600,1200)+i*60, {scaleMultiplier:lD.ai*0.3+0.7});
            if(lD.es !== "fiatLuxIgnisExplosion") {for(let i=0;i<Math.ceil(lD.ai*20);i++)creaIgnisDivinusPerfectissima(K_DIVINI_MODI.RAND(150,700)+i*20,lD.ai*K_DIVINI_MODI.RAND(0.8,2.2));}
            creaChorusAngelorumPerfectissimus(K_DIVINI_MODI.RAND(800,1400),K_DIVINI_MODI.CHOICE(['seraphim','cherubim','thrones','dominatio','virtus']),{x:K_DIVINI_MODI.RAND(20,80),y:K_DIVINI_MODI.RAND(20,80),z:K_DIVINI_MODI.RAND(-700,700)},{radMin:250*lD.ai,radMax:1200*lD.ai,velMin:0.4*lD.ai,velMax:2*lD.ai,compMin:4,compMax:9,numPart:Math.ceil(lD.ai*3),auraLayers:K_DIVINI_MODI.RAND_INT(1,3),trailLength:K_DIVINI_MODI.RAND(3,8)*lD.ai});
            if(Math.random()<lD.ai*0.85)creaSophiaNebulaPerfectissima(K_DIVINI_MODI.RAND(1200,2000));
            if(Math.random()<lD.ai*0.75)creaGratiaFlumenPerfectissimum(K_DIVINI_MODI.RAND(900,1600));
        }, d);
    }

    function activateIgnisDivinusContinuus(interval, intensity) {
        if (M_DIVINITAS.ignisIntervalId) clearInterval(M_DIVINITAS.ignisIntervalId);
        M_DIVINITAS.ignisIntervalId = setInterval(() => {
            if (!M_DIVINITAS.activa) {
                clearInterval(M_DIVINITAS.ignisIntervalId);
                return;
            }
            creaIgnisDivinusPerfectissima(0, K_DIVINI_MODI.RAND(0.5, 1.5) * intensity);
        }, interval / intensity);
        M_DIVINITAS.elementaActiva.add(M_DIVINITAS.ignisIntervalId);
    }

    /* ORCHESTRATIO ET REDITUS ANAGOGICUS (PERFECTISSIMI) */
    function initiaTheophaniamPerfectissimam(){ 
        M_DIVINITAS.paginaInitTimestamp = Date.now();

        // Ensure Principium exists if D_ELEMENTA.principium is null (e.g. after full cycle reditus)
        // The new logic in fiatLuxCosmica might also create it, but this ensures it for the very first "Tohu vaVohu" if needed.
        if (!D_ELEMENTA.principium) {
            const newPrincipium = document.createElement('div');
            newPrincipium.id = 'principium-incognitum';
            if (D_ELEMENTA.theatrum) {
                D_ELEMENTA.theatrum.appendChild(newPrincipium);
            } else {
                console.warn("Theatrum Divinum non repertum est pro Principio creando mature (initiaTheophaniamPerfectissimam).");
                document.body.appendChild(newPrincipium);
            }
        }

        // Initial effects moved to be triggered by "Fiat Lux"
        // manifestaPrincipiumPerfectissimum(); // This is now triggered by Fiat Lux

        manifestaLogosPerfectissima(K_TEMPORA_PERFECTISSIMA.logosPrimProclam); // "תהו ובהו" in darkness
        // Continuous effects also moved to Fiat Lux
    }

    function initiaReditumAnagogicumPerfectissimum(){
        if(!M_DIVINITAS.activa)return;
        M_DIVINITAS.activa = false;
        if(M_DIVINITAS.ignisIntervalId){clearInterval(M_DIVINITAS.ignisIntervalId);M_DIVINITAS.ignisIntervalId=null;}
        M_DIVINITAS.elementaActiva.forEach(eOI=>{if(typeof eOI==='number'){clearInterval(eOI);}else if(eOI&&typeof eOI.animate==='function'&&eOI.id!=='principium-incognitum'){if(eOI.parentNode){const anim=eOI.animate([{opacity:getComputedStyle(eOI).opacity||1},{opacity:0}],{duration:K_DIVINI_MODI.RAND(15000,25000),easing:'ease-in',fill:'forwards'});anim.onfinish=()=>{if(eOI.parentNode)eOI.remove();};}}});
        M_DIVINITAS.elementaActiva.clear();
        const lFDP=K_LOGOS_ULTRA_PERFECTISSIMA[K_LOGOS_ULTRA_PERFECTISSIMA.length-1];
        setTimeout(()=>{
            const vFC=document.createElement('div');vFC.classList.add('verbum-container');const vFP=document.createElement('div');vFP.classList.add('verbum-principale');vFP.textContent=lFDP.t;vFP.style.fontFamily=lFDP.f;const bFSF=parseFloat(lFDP.sr)*8;vFP.style.fontSize=`clamp(${bFSF*0.3}em,${bFSF*0.8}vw,${bFSF*1.1}em)`;vFP.style.color=lFDP.c;vFP.style.textShadow='0 0 15px var(--scintilla-prima),0 0 30px var(--pleroma-alba-margarita),0 0 50px var(--reditus-viola-obscura)';vFC.appendChild(vFP);
            if(lFDP.gl){const vGF=document.createElement('div');vGF.classList.add('verbum-glosa-latina');vGF.textContent=lFDP.gl;const gFSzF=(parseFloat(vFP.style.fontSize.match(/(\d*\.?\d*)vw/)?.[1]||bFSF*0.8*0.25))*0.25;vGF.style.fontSize=`${Math.max(0.7,gFSzF)}em`;vGF.style.marginTop=`${Math.max(0.25,gFSzF*0.2)}em`;vGF.style.color="var(--reditus-viola-obscura)";vFC.appendChild(vGF);}
            vFC.style.setProperty('--rand-rotY-start','0deg');vFC.style.setProperty('--rand-rotX-end','-5deg');vFC.style.setProperty('--rand-rotY-end','0deg');vFC.style.animation=`verbumEmergentiaDivina ${K_TEMPORA_PERFECTISSIMA.logosFinalDur}s cubic-bezier(0.68,-0.65,0.265,1.55) forwards`;
            D_ELEMENTA.logosThronus.appendChild(vFC);
            vFC.addEventListener('animationend',()=>{
                if(vFC.parentNode) vFC.remove();
                const p = D_ELEMENTA.principium;
                if(p&&p.parentNode){
                    p.animate([
                        {opacity:getComputedStyle(p).opacity||0.95,transform:getComputedStyle(p).transform||'translate3d(-50%,-50%,0px) scale(1)',filter:getComputedStyle(p).filter||'brightness(3)', boxShadow: getComputedStyle(p).boxShadow},
                        {opacity:1,transform:'translate3d(-50%,-50%,-300px) scale(10)',filter:'brightness(80) invert(1) blur(2px)',boxShadow:'0 0 1500px 750px var(--kenoma-profundum),0 0 800px 400px var(--scintilla-prima)',offset:0.75},
                        {opacity:0,transform:'translate3d(-50%,-50%,-3000px) scale(0.000001)',filter:'brightness(0) blur(10px)',boxShadow:'none',offset:1}],
                        {duration:35000,easing:'cubic-bezier(0.86, 0, 0.07, 1)',fill:'forwards'}
                    ).onfinish=()=>{
                        if(p.parentNode)p.remove();
                        document.body.animate([{backgroundColor:'var(--kenoma-profundum)'},{backgroundColor:'#000000'}],{duration:20000,fill:'forwards',delay:3000});
                        if (M_DIVINITAS.idFrameAnim) cancelAnimationFrame(M_DIVINITAS.idFrameAnim);
                        M_DIVINITAS.idFrameAnim=null;
                        console.log("THEOSIS CONSUMMATA EST. SILENTIUM DIVINUM POST OMNIA.");
                    };
                } else {
                    document.body.animate([{backgroundColor:'var(--kenoma-profundum)'},{backgroundColor:'#000000'}],{duration:20000,fill:'forwards',delay:3000});
                    if (M_DIVINITAS.idFrameAnim) cancelAnimationFrame(M_DIVINITAS.idFrameAnim);
                    M_DIVINITAS.idFrameAnim=null;
                }
            });
        },15000);
    }


    /* ANIMATIONIS MAGISTRA OPERATIO (RAF) PERFECTISSIMA */
    function ansaAnimMagistraPerfectissima(t){
        if(!M_DIVINITAS.tmpUltimum)M_DIVINITAS.tmpUltimum=t;
        if (M_DIVINITAS.activa || M_DIVINITAS.particulaeAetheris.length > 0) reddeAetherPerfectissima(t);
        if(M_DIVINITAS.idFrameAnim!==null) M_DIVINITAS.idFrameAnim=requestAnimationFrame(ansaAnimMagistraPerfectissima);
    }

    /* INITIUM POST ONUS PAGINAE COMPLETUM */
    document.addEventListener('DOMContentLoaded',()=>{
        if (document.body) { // Ensure body exists
            document.body.style.opacity = '0';
            document.body.style.backgroundColor = 'var(--kenoma-profundum)';
        }

        initAetherCanvasPerfectissima();
        M_DIVINITAS.idFrameAnim = requestAnimationFrame(ansaAnimMagistraPerfectissima);

        if (D_ELEMENTA.btnVisioPlena) { // Ensure button exists before adding listener
            D_ELEMENTA.btnVisioPlena.addEventListener('click',()=>{
                const e=document.documentElement;
                if(!document.fullscreenElement&&!document.webkitFullscreenElement){
                    if(e.requestFullscreen)e.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
                    else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();
                }
            });
        }

        // Call initiaTheophaniamPerfectissimam after a short delay
        // This allows initial styles to apply and DOM to be fully ready.
        setTimeout(initiaTheophaniamPerfectissimam, 100);
    });

  </script>
</body>
</html>